(()=>{"use strict";var e,t,n=function(e,t,n,s){return new(n||(n=Promise))((function(l,i){function a(e){try{o(s.next(e))}catch(e){i(e)}}function d(e){try{o(s.throw(e))}catch(e){i(e)}}function o(e){var t;e.done?l(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,d)}o((s=s.apply(e,t||[])).next())}))};class s extends HTMLElement{connectedCallback(){const e=this.attachShadow({mode:"open"}),t=document.getElementById("app-template");e.appendChild(t.content.cloneNode(!0)),this.searchElement=e.getElementById("search"),this.searchTypeElement=e.getElementById("search-method"),this.searchResultsElement=e.getElementById("search-results"),this.getPlaylistButton=e.getElementById("get-playlist"),this.danceability=e.getElementById("danceability"),this.energy=e.getElementById("energy"),this.popularity=e.getElementById("popularity"),this.valence=e.getElementById("valence"),this.seedsElement={artist:e.getElementById("artist-seeds"),track:e.getElementById("track-seeds")},this.playlistElement=e.getElementById("playlist"),this.playlistOrdered=e.getElementById("playlist-ordered"),this.savePlaylistButton=e.getElementById("save-playlist"),this.clearPlaylistButton=e.getElementById("clear-playlist"),this.resultsElement=e.getElementById("results"),this.searchElement.addEventListener("keyup",this.handleSearchKeyup.bind(this)),this.searchElement.addEventListener("search",this.handleSearchEvent.bind(this)),this.searchTypeElement.addEventListener("change",this.searchQuery.bind(this)),this.getPlaylistButton.addEventListener("click",this.handleGetPlaylistButtonClick.bind(this)),this.clearPlaylistButton.addEventListener("click",this.clearPlaylist.bind(this))}handleSearchKeyup(e){this.searchElement.value||this.clearResults(),"Enter"===e.key&&this.searchQuery()}handleSearchEvent(e){this.searchElement.value||this.clearResults()}handleGetPlaylistButtonClick(e){if(!this.hasSeeds())return console.error("The button abides");this.clearResults(),this.getPlaylist()}searchQuery(){var e;return n(this,void 0,void 0,(function*(){const t=this.searchElement.value;if(!t||t.length<1)return;const n=null===(e=this.searchTypeElement.querySelector('input[type="radio"]:checked').parentElement)||void 0===e?void 0:e.textContent;if("artist"!=n&&"track"!=n)return console.error("invalid type");const s=`https://api.cowell.dev/search?q=${t}&type=${n}`;try{const e=yield fetch(s,{method:"GET",credentials:"include"}),t=(yield e.json())[n+"s"].items;this.showResults(t)}catch(e){console.error(e)}}))}showResults(e){var t;null===(t=this.searchResultsElement)||void 0===t||t.replaceChildren(),e.forEach((e=>{var t;const n=document.createElement("li");let s=e.name;"track"==e.type&&(s=e.artists[0].name+" - "+s),n.textContent=s,n.dataset.id=e.id,n.dataset.type=e.type,n.addEventListener("click",this.addItemToSeeds.bind(this)),null===(t=this.searchResultsElement)||void 0===t||t.appendChild(n)}))}clearResults(){this.searchResultsElement.replaceChildren()}addItemToSeeds(e){const t=e.target,n=this.seedsElement[t.dataset.type],s=null==n?void 0:n.querySelectorAll("li");let l=!0;if(null!=s){if(s.length>=5)return void alert("Max of 5 items per seed");null==s||s.forEach((e=>{e.dataset.id!=t.dataset.id||(l=!1)}))}if(l){const e=document.createElement("li");e.textContent=t.textContent,e.dataset.id=t.dataset.id,e.addEventListener("click",this.deleteItemFromSeeds.bind(this)),null==n||n.appendChild(e)}this.checkButton()}deleteItemFromSeeds(e){e.target.remove(),this.checkButton()}hasSeeds(){var e,t,n,s;const l=(null===(t=null===(e=this.shadowRoot)||void 0===e?void 0:e.getElementById("artist-seeds"))||void 0===t?void 0:t.hasChildNodes())||!1,i=(null===(s=null===(n=this.shadowRoot)||void 0===n?void 0:n.getElementById("track-seeds"))||void 0===s?void 0:s.hasChildNodes())||!1;return l||i}checkButton(){var e;const t=null===(e=this.shadowRoot)||void 0===e?void 0:e.getElementById("get-playlist");this.hasSeeds()?t.disabled=!1:t.disabled=!0}getSeeds(e){var t;const n=null===(t=this.shadowRoot)||void 0===t?void 0:t.getElementById(e+"-seeds");if(!(null==n?void 0:n.hasChildNodes))return[];const s=null==n?void 0:n.querySelectorAll("li"),l=null==s?void 0:s.length,i=[];for(let e=0;e<l;e++){const t=s[e].dataset.id;null!=t&&i.push(t)}return i}getPlaylist(){return n(this,void 0,void 0,(function*(){let e=`https://api.cowell.dev/rec\n\t\t\t?seed_artists=${this.getSeeds("artist").join(",")}\n\t\t\t&seed_tracks=${this.getSeeds("track").join(",")}\n\t\t\t&target_danceability=${this.danceability.value}\n\t\t\t&target_energy=${this.energy.value}\n\t\t\t&target_popularity=${this.popularity.value}\n\t\t\t&target_valence=${this.valence.value}\n\t\t`;const t=yield fetch(e,{method:"GET",credentials:"include"}),n=(yield t.json()).tracks;this.addTracksToPlaylist(n)}))}addTracksToPlaylist(e){this.playlistOrdered.replaceChildren();const t=[];e.forEach((e=>{const n=document.createElement("li");n.textContent=e.artists[0].name+" - "+e.name,t.push(e.uri),this.playlistOrdered.appendChild(n)})),this.playlistElement.hidden=!1,this.savePlaylistButton.addEventListener("click",(e=>{this.addPlaylistToUserLibray(t)})),this.savePlaylistButton.classList.remove("hidden"),this.playlistElement.classList.remove("hidden")}addPlaylistToUserLibray(e){return n(this,void 0,void 0,(function*(){const t={uris:[]};t.uris=e;const n=yield fetch("https://api.cowell.dev/playlist",{method:"POST",credentials:"include",body:JSON.stringify(t),headers:new Headers({"Content-Type":"application/json"})}),s=yield n.json(),l=document.createElement("a");l.href=`https://open.spotify.com/user/${s.username}/playlist/${s.id}`,l.target="_blank",l.textContent=l.href,this.resultsElement.replaceChildren(l),this.clearPlaylist()}))}clearPlaylist(){this.playlistOrdered.replaceChildren(),this.playlistElement.classList.add("hidden")}}class l extends HTMLElement{connectedCallback(){const e=document.createElement("button");e.type="button",e.textContent=this.textContent,e.addEventListener("click",this.handleButtonClick.bind(this)),this.replaceChildren(e)}handleButtonClick(){location.href=this.dataset.href||"#"}}t=function*(){window.customElements.define("app-container",s),window.customElements.define("link-button",l);const e=document.getElementById("app");try{const t=yield fetch("https://api.cowell.dev/auth",{method:"GET",credentials:"include"}),n=document.querySelector("header");if(t.ok){n.innerHTML+="<link-button data-href='https://api.cowell.dev/auth/logout'>Logout</link-button>";const t=document.createElement("app-container");e.appendChild(t)}else n.innerHTML+="<link-button data-href='https://api.cowell.dev/auth/login'>Login with Spotify</link-button>"}catch(e){console.error(e);let t="Something went wrong...";"TypeError: Failed to fetch"==e&&(t="Unable to fetch server :("),console.log(t)}},new((e=void 0)||(e=Promise))((function(n,s){function l(e){try{a(t.next(e))}catch(e){s(e)}}function i(e){try{a(t.throw(e))}catch(e){s(e)}}function a(t){var s;t.done?n(t.value):(s=t.value,s instanceof e?s:new e((function(e){e(s)}))).then(l,i)}a((t=t.apply(void 0,[])).next())}))})();